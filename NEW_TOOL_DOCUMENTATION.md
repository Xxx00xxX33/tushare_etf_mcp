# 新工具文档：get_top_etfs_by_period

## 📋 概述

`get_top_etfs_by_period` 是一个高效的 ETF 涨幅排行工具，支持按时间周期（当日/周/月）获取涨幅前 N 的 ETF。

## ✨ 核心特性

### 1. 智能数据源选择
- **当日涨幅**：使用 AkShare `fund_etf_spot_em` 接口（2-3 秒）
- **周/月涨幅**：使用 Tushare `fund_basic` + `fund_nav` 接口（20-40 秒）

### 2. 性能优化
- 当日查询：一次性获取所有 ETF 实时行情，无需循环
- 周/月查询：限制处理数量，避免超时
- 超时保护：单个 API 10 秒，整体 50 秒

### 3. 用户友好
- 灵活的参数配置
- 清晰的输出格式
- 详细的处理信息

## 📊 参数说明

| 参数名 | 类型 | 默认值 | 描述 | 可选值 |
|--------|------|--------|------|--------|
| `period` | string | "day" | 时间周期 | "day", "week", "month" |
| `limit` | integer | 10 | 返回数量 | 1-50 |
| `market` | string | "E" | 市场类型 | "E"(ETF), "O"(LOF) |

## 🎯 使用示例

### 示例 1：获取当日涨幅前 10 的 ETF（默认）

```json
{
  "period": "day",
  "limit": 10
}
```

**预期输出**:
```
当日涨幅前 10 的 ETF：

1. 半导体ETF (512480)
   最新价: 1.23  涨跌幅: 5.67%  成交额: 12.34亿
   主力净流入: 2.56亿

2. 新能源车ETF (515030)
   最新价: 0.98  涨跌幅: 4.89%  成交额: 8.92亿
   主力净流入: 1.78亿

...

处理时间: 2.3 秒
```

### 示例 2：获取近一周涨幅前 5 的 ETF

```json
{
  "period": "week",
  "limit": 5
}
```

**预期输出**:
```
近一周涨幅前 5 的 ETF：

1. 半导体ETF (512480.SH)
   近一周涨幅: 12.34%

2. 新能源车ETF (515030.SH)
   近一周涨幅: 10.56%

...

处理时间: 18.7 秒
```

### 示例 3：获取近一月涨幅前 20 的 ETF

```json
{
  "period": "month",
  "limit": 20
}
```

## 🔄 工作流程

### 当日涨幅查询流程

```
用户请求 (period="day")
    ↓
调用 AkShare fund_etf_spot_em
    ↓
获取所有 ETF 实时行情
    ↓
按涨跌幅降序排序
    ↓
取前 N 个
    ↓
格式化输出
```

**优势**:
- ✅ 一次性获取所有数据
- ✅ 无需循环调用 API
- ✅ 耗时仅 2-3 秒
- ✅ 节省大量 token

### 周/月涨幅查询流程

```
用户请求 (period="week"/"month")
    ↓
计算日期范围
    ↓
获取 ETF 列表
    ↓
限制处理数量 (limit * 3)
    ↓
循环获取每个 ETF 的历史数据
    ├─ 超时保护：单个 10 秒
    ├─ 整体超时：50 秒
    └─ 错误跳过：继续处理下一个
    ↓
计算涨幅
    ↓
按涨幅降序排序
    ↓
取前 N 个
    ↓
格式化输出
```

**优势**:
- ✅ 支持自定义时间区间
- ✅ 历史数据完整
- ✅ 超时保护完善
- ✅ 错误处理健壮

## ⚡ 性能对比

| 指标 | 当日涨幅 | 周涨幅 | 月涨幅 |
|------|---------|--------|--------|
| 数据源 | AkShare | Tushare | Tushare |
| API 调用次数 | 1 次 | N+1 次 | N+1 次 |
| 预计耗时 | 2-3 秒 | 20-30 秒 | 30-40 秒 |
| Token 消耗 | 低 | 中 | 中 |
| 推荐场景 | 实时监控 | 短期分析 | 中期分析 |

## 🛡️ 超时保护机制

### 当日涨幅
- **单次 API 调用**: 10 秒超时
- **总耗时**: 预计 2-3 秒

### 周/月涨幅
- **初始列表获取**: 15 秒超时
- **单个 ETF 数据**: 10 秒超时
- **整体超时**: 50 秒
- **处理数量限制**: limit * 3

## 📝 输出格式

### 当日涨幅输出字段
- 代码
- 名称
- 最新价
- 涨跌幅
- 成交额
- 主力净流入

### 周/月涨幅输出字段
- 代码
- 名称
- 涨幅百分比

### 附加信息
- 处理时间
- 数据限制说明（如有）

## ⚠️ 注意事项

### 1. 数据源差异
- **AkShare**: 提供实时行情，包含主力资金流向
- **Tushare**: 提供历史数据，需要计算涨幅

### 2. 时间范围
- **当日**: 当前交易日的实时数据
- **周**: 近 7 个自然日的数据
- **月**: 近 30 个自然日的数据

### 3. 数据完整性
- 部分 ETF 可能因数据不足而无法计算涨幅
- 周/月查询返回数量可能少于 limit 参数

### 4. API 限制
- Tushare 有访问频率限制（每分钟 5 次）
- 大量查询可能触发限流

## 🔧 故障排查

### 问题 1：超时错误
**原因**: 网络延迟或 API 响应慢  
**解决**: 
- 减小 limit 参数
- 使用当日涨幅（更快）
- 检查网络连接

### 问题 2：返回数量不足
**原因**: 部分 ETF 数据不足  
**解决**: 
- 增大 limit 参数（处理更多 ETF）
- 检查日期范围是否合理

### 问题 3：AkShare 导入错误
**原因**: akshare 未安装  
**解决**: 
```bash
pip install akshare>=1.11.0
```

## 📚 相关文档

- [AkShare 官方文档](https://akshare.akfamily.xyz/)
- [Tushare 官方文档](https://tushare.pro/)
- [PERFORMANCE_OPTIMIZATION.md](./PERFORMANCE_OPTIMIZATION.md) - 性能优化详解
- [TIMEOUT_FIX.md](./TIMEOUT_FIX.md) - 超时问题修复

## 🎉 总结

`get_top_etfs_by_period` 工具通过智能选择数据源，实现了高效的 ETF 涨幅排行查询：

- ✅ **快速**: 当日查询仅需 2-3 秒
- ✅ **灵活**: 支持多种时间周期
- ✅ **稳定**: 完善的超时保护
- ✅ **易用**: 简单的参数配置

推荐在需要快速了解市场热点时使用当日涨幅查询，在需要分析趋势时使用周/月涨幅查询。
